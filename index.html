<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>GitPageOne - Red</title>
</head>
<body style="background-color: crimson;height:100vh;">
<div style="width: 360px;color: #fff;font-size: 32px;margin: 200px auto; text-align:center;">
    I'm the RED PAGE
</div>
<div style="width: 360px;color: #fff;font-size: 32px;margin: 100px auto; text-align:center;">
    <button id="updateSW-button">Update service worker</button>
</div>

<script>
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
                        .replace(/\-/g, '+')
                        .replace(/_/g, '/')
                ;
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0)));
    }

    function WPN(){
        if( ! 'serviceWorker' in navigator){
            console.log('Service Worker isn\'t supported on this browser, disable or hide UI.');
            return;
        }
        if( ! 'PushManager' in window){
            console.log('Push Notifications aren\'t supported on this browser, disable or hide UI.');
            return;
        }
        registerServiceWorker();
        subscribeUserToPush();
    }

    function registerServiceWorker() {
        return navigator.serviceWorker.register('service-worker.js')
                .then(function(registration) {
                    console.log('Service worker successfully registered.');
                    const button = document.getElementById('updateSW-button');
                    button.addEventListener('click', function(){
                        console.log('updating service worker');
                        registration.update();
                    });
                    return registration;
                })
                .catch(function(err) {
                    console.error('Unable to register service worker.', err);
                });
    }

    function askPermission() {
        return new Promise(function(resolve, reject){
            const permissionResult = Notification.requestPermission(function(result){
                resolve(result);
            });

            if(permissionResult) {
                permissionResult.then(resolve, reject);
            }
        }).then(function(permissionResult){
                    console.log('permissionResult: ', permissionResult);
                    if(permissionResult !== 'granted'){
                        throw new Error('Permission not granted');
                    }
                });
    }

    function subscribeUserToPush(){
        return navigator.serviceWorker.ready
                .then(function(serviceWorkerRegistration){

                    const subscribeOptions = {
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(
                                'BHYnI0mIUtKBrTrO-6o3FssE124d2OQU4bdqn9RCQWvVsXrFGEXIKmy4G81F_aS6Zh2_fNMc_2v4DrjekZ4e5as'
                        )
                    };

                    return serviceWorkerRegistration.pushManager.subscribe(subscribeOptions);
                })
                .then(function(pushSubscription){
                    console.log('Received PushSubscription: ', JSON.stringify(pushSubscription));

                    // sending subscription to backend
                    sendSubscriptionToBackEnd(pushSubscription);

                    return pushSubscription;
                });
    }

    function sendSubscriptionToBackEnd(subscription) {
        let payload = {
            browser: "justwannamakeSURE",
            browser_lang: "en",
            browser_version: "3112.0.60",
            endpoint: subscription.endpoint,
            meta: JSON.stringify(subscription),
            welcome_lang: "en"
        };
        console.log('payload');
        console.log(payload);
        return fetch('https://asroma.pushsm.com/api/push-tokens', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/vnd.notifications.v1+json',
                'Content-Type': 'application/json',
                'X-Push-Auth-Token': 'zxcccccccccccccz',
                'X-Client-Language': navigator.language.substring(0, 2)
            },
            body: JSON.stringify(payload)
        })
                .then(function(response) {
                    console.log('response');
                    console.log(response);
                    if (!response.ok) {
                        throw new Error('Bad status code from server.');
                    }

                    return response.json();
                })
                .then(function(responseData) {
                    if (!(responseData.data && responseData.data.success)) {
                        throw new Error('Bad response from server.');
                    }
                });
    }

    WPN();
</script>
</body>
</html>
